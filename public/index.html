<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Machine Status</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #05060a;
        --panel: rgba(16, 19, 30, 0.9);
        --panel-2: rgba(20, 26, 41, 0.85);
        --accent: #5af8ff;
        --accent-2: #9a5cff;
        --muted: #7f8ca5;
        --text: #e8f1ff;
        --danger: #ff6b6b;
        --success: #6bf7c4;
        --glow: 0 0 30px rgba(90, 248, 255, 0.35);
        --radius: 18px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: radial-gradient(circle at 20% 20%, rgba(90, 248, 255, 0.08), transparent 35%),
          radial-gradient(circle at 80% 0%, rgba(154, 92, 255, 0.1), transparent 30%),
          linear-gradient(145deg, #04060a 0%, #060915 50%, #03040a 100%);
        color: var(--text);
        font-family: 'Space Grotesk', 'Segoe UI', sans-serif;
        min-height: 100vh;
        padding: 32px clamp(16px, 3vw, 42px);
      }

      .shell {
        max-width: 1200px;
        margin: 0 auto 80px;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 26px;
      }

      .title {
        display: grid;
        gap: 8px;
      }

      .title h1 {
        margin: 0;
        font-size: clamp(28px, 4vw, 42px);
        letter-spacing: -0.5px;
      }

      .title p {
        margin: 0;
        color: var(--muted);
      }

      .pill {
        background: linear-gradient(135deg, rgba(90, 248, 255, 0.12), rgba(154, 92, 255, 0.12));
        border: 1px solid rgba(90, 248, 255, 0.3);
        color: var(--accent);
        padding: 12px 16px;
        border-radius: 999px;
        font-size: 14px;
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
      }

      .card {
        background: var(--panel);
        border: 1px solid rgba(90, 248, 255, 0.12);
        border-radius: var(--radius);
        padding: 16px 18px;
        backdrop-filter: blur(6px);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      }

      .card h3 {
        margin: 0 0 10px;
        font-size: 16px;
        color: var(--muted);
        letter-spacing: 0.3px;
      }

      .card .value {
        font-size: 20px;
        font-weight: 600;
      }

      .flex {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .tag {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(90, 248, 255, 0.2);
        color: var(--accent);
        font-size: 12px;
        background: rgba(90, 248, 255, 0.06);
      }

      .controls {
        margin: 22px 0 10px;
      }

      .button {
        border: 1px solid rgba(90, 248, 255, 0.35);
        background: linear-gradient(135deg, rgba(90, 248, 255, 0.18), rgba(154, 92, 255, 0.18));
        color: var(--text);
        padding: 12px 16px;
        border-radius: 12px;
        font-weight: 600;
        font-family: 'JetBrains Mono', monospace;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      }

      .button:hover {
        transform: translateY(-1px);
        box-shadow: var(--glow);
      }

      .button.danger {
        border-color: rgba(255, 107, 107, 0.4);
        background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 128, 170, 0.2));
        color: #ffdede;
      }

      .button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      canvas {
        width: 100%;
        max-height: 320px;
      }

      .status {
        margin-top: 10px;
        color: var(--muted);
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
      }

      @media (max-width: 720px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .controls .button {
          width: 100%;
        }

        .grid {
          grid-template-columns: 1fr;
        }

        canvas {
          max-height: 240px;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div class="title">
          <h1>Machine Telemetry</h1>
          <p>Realtime system health, right off the wire.</p>
        </div>
        <div id="hostnamePill" class="pill">loading...</div>
      </header>

      <div class="grid" id="infoGrid">
        <div class="card">
          <h3>Operating System</h3>
          <div class="value" id="osValue">--</div>
          <div class="flex">
            <span class="tag" id="archTag">--</span>
            <span class="tag" id="timezoneTag">--</span>
          </div>
        </div>
        <div class="card">
          <h3>Time On Machine</h3>
          <div class="value" id="currentTimeValue">--</div>
          <div class="tag" id="uptimeValue">--</div>
        </div>
        <div class="card">
          <h3>Machine Age</h3>
          <div class="value" id="machineAgeValue">Unknown</div>
          <div class="tag">Birthdate: <span id="machineBirthTag">--</span></div>
        </div>
        <div class="card">
          <h3>CPU</h3>
          <div class="value" id="cpuValue">--</div>
          <div class="tag" id="coresTag">-- cores</div>
        </div>
        <div class="card">
          <h3>RAM</h3>
          <div class="value" id="ramValue">--</div>
          <div class="tag" id="ramFreeTag">-- free</div>
        </div>
        <div class="card">
          <h3>GPU</h3>
          <div class="value" id="gpuValue">--</div>
          <div class="tag" id="gpuUtilTag">--</div>
        </div>
        <div class="card">
          <h3>CPU Temp</h3>
          <div class="value" id="cpuTempValue">--</div>
          <div class="tag">Live</div>
        </div>
        <div class="card">
          <h3>GPU Temp</h3>
          <div class="value" id="gpuTempValue">--</div>
          <div class="tag">Live</div>
        </div>
        <div class="card">
          <h3>Network</h3>
          <div class="value" id="netSpeedValue">--</div>
          <div class="tag">Down / Up</div>
        </div>
        <div class="card">
          <h3>Battery</h3>
          <div class="value" id="batteryValue">--</div>
          <div class="tag" id="batteryHealthTag">--</div>
        </div>
      </div>

      <div class="controls flex">
        <button class="button" id="rebootBtn">↺ reboot</button>
        <button class="button danger" id="shutdownBtn">⏻ shutdown</button>
        <div class="status" id="statusText">Power controls disabled by default.</div>
      </div>

      <div class="grid" style="margin-top: 12px">
        <div class="card">
          <h3>CPU Load</h3>
          <canvas id="cpuCanvas"></canvas>
          <div class="flex" style="margin-top: 8px; align-items: center">
            <div class="status" id="cpuStatus">Live</div>
            <span class="status" id="cpuWindowLabel" style="margin-left: auto">120s window</span>
          </div>
        </div>
        <div class="card">
          <h3>RAM Usage</h3>
          <canvas id="ramCanvas"></canvas>
          <div class="flex" style="margin-top: 8px; align-items: center">
            <div class="status" id="ramStatus">Live</div>
            <span class="status" id="ramWindowLabel" style="margin-left: auto">120s window</span>
          </div>
        </div>
        <div class="card">
          <h3>GPU Load</h3>
          <canvas id="gpuCanvas"></canvas>
          <div class="flex" style="margin-top: 8px; align-items: center">
            <div class="status" id="gpuStatus">Live</div>
            <span class="status" id="gpuWindowLabel" style="margin-left: auto">120s window</span>
          </div>
        </div>
        <div class="card">
          <h3>Network Speed</h3>
          <canvas id="netCanvas"></canvas>
          <div class="flex" style="margin-top: 8px; align-items: center">
            <div class="status" id="netStatus">Down / Up</div>
            <span class="status" id="netWindowLabel" style="margin-left: auto">120s window</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      const fmtBytes = (bytes) => {
        if (!bytes && bytes !== 0) return '--';
        const units = ['B', 'KB', 'MB', 'GB', 'TB'];
        let i = 0;
        let val = bytes;
        while (val >= 1024 && i < units.length - 1) {
          val /= 1024;
          i++;
        }
        return `${val.toFixed(val >= 10 ? 0 : 1)} ${units[i]}`;
      };

      const state = {
        labels: [],
        series: {
          cpu: [],
          ram: [],
          gpu: [],
          netDown: [],
          netUp: [],
        },
        windowSize: 120,
        charts: {},
      };

      async function fetchInfo() {
        try {
          const res = await fetch('/api/info');
          const info = await res.json();
          renderInfo(info);
        } catch (err) {
          console.error(err);
          document.getElementById('statusText').textContent = 'Failed to load system info.';
        }
      }

      function renderInfo(info) {
        document.getElementById('hostnamePill').textContent = info.hostname;
        document.getElementById('osValue').textContent = info.os;
        document.getElementById('archTag').textContent = info.arch;
        document.getElementById('timezoneTag').textContent = info.timezone;
        document.getElementById('currentTimeValue').textContent = new Date(info.currentTime).toLocaleString();
        document.getElementById('uptimeValue').textContent = 'Uptime ' + info.uptimeHuman;

        if (info.machineAge) {
          document.getElementById('machineAgeValue').textContent = info.machineAge.human;
          document.getElementById('machineBirthTag').textContent = info.machineAge.iso.split('T')[0];
        } else {
          document.getElementById('machineAgeValue').textContent = 'Unknown';
          document.getElementById('machineBirthTag').textContent = '--';
        }

        document.getElementById('cpuValue').textContent = info.cpu.model;
        document.getElementById('coresTag').textContent = `${info.cpu.cores} cores @ ${info.cpu.speedGHz} GHz`;
        document.getElementById('ramValue').textContent = fmtBytes(info.memory.used) + ' / ' + fmtBytes(info.memory.total);
        document.getElementById('ramFreeTag').textContent = fmtBytes(info.memory.free) + ' free';

        const gpu = info.gpu && info.gpu.length ? info.gpu[0] : null;
        if (gpu) {
          document.getElementById('gpuValue').textContent = gpu.model;
          document.getElementById('gpuUtilTag').textContent =
            gpu.utilization != null ? `${gpu.utilization.toFixed(0)}% util` : 'utilization N/A';
        } else {
          document.getElementById('gpuValue').textContent = 'N/A';
          document.getElementById('gpuUtilTag').textContent = '--';
        }

        if (info.temperatures) {
          document.getElementById('cpuTempValue').textContent = info.temperatures.cpu ? `${info.temperatures.cpu.toFixed(0)}°C` : 'N/A';
          document.getElementById('gpuTempValue').textContent = info.temperatures.gpu ? `${info.temperatures.gpu.toFixed(0)}°C` : 'N/A';
        }

        if (info.battery) {
          const pct = info.battery.percent != null ? `${info.battery.percent.toFixed(0)}%` : 'Unknown';
          const health = info.battery.health != null ? `${info.battery.health.toFixed(0)}% health` : 'Health N/A';
          const charging = info.battery.isCharging ? 'charging' : 'discharging';
          document.getElementById('batteryValue').textContent = `${pct} (${charging})`;
          document.getElementById('batteryHealthTag').textContent = health;
        } else {
          document.getElementById('batteryValue').textContent = 'No battery';
          document.getElementById('batteryHealthTag').textContent = '--';
        }

        const statusEl = document.getElementById('statusText');
        const rebootBtn = document.getElementById('rebootBtn');
        const shutdownBtn = document.getElementById('shutdownBtn');
        if (info.powerControlsEnabled) {
          statusEl.textContent = 'Power controls enabled. Commands execute on host.';
          rebootBtn.disabled = shutdownBtn.disabled = false;
        } else {
          statusEl.textContent = 'Power controls disabled. Set ENABLE_POWER_CONTROLS=true to allow.';
          rebootBtn.disabled = shutdownBtn.disabled = true;
        }
      }

      function initCharts() {
        ['cpu', 'ram', 'gpu', 'net'].forEach((key) => {
          const canvas = document.getElementById(`${key}Canvas`);
          const ctx = canvas.getContext('2d');
          state.charts[key] = { canvas, ctx, points: [] };
          resizeCanvas(canvas);
          canvas.addEventListener('mousemove', (e) => handleHover(key, e));
          canvas.addEventListener('mouseleave', () => showTooltip(null));
        });
        window.addEventListener('resize', () => {
          Object.values(state.charts).forEach((chart) => resizeCanvas(chart.canvas));
          drawAll();
        });
        drawAll();
      }

      function pushPoint(label, cpu, gpu, ram, netDown, netUp) {
        const max = 600;
        state.labels.push(label);
        state.series.cpu.push(cpu);
        state.series.gpu.push(gpu);
        state.series.ram.push(ram);
        state.series.netDown.push(netDown);
        state.series.netUp.push(netUp);
        if (state.labels.length > max) {
          Object.keys(state.series).forEach((k) => state.series[k].shift());
          state.labels.shift();
        }
        drawAll();
      }

      function connectWs() {
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${protocol}://${window.location.host}/ws/metrics`);

        ws.onopen = () => {
          ['cpuStatus', 'ramStatus', 'gpuStatus', 'netStatus'].forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.textContent = 'Live';
          });
        };
        ws.onerror = () => {
          ['cpuStatus', 'ramStatus', 'gpuStatus', 'netStatus'].forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.textContent = 'WebSocket error';
          });
        };
        ws.onclose = () => {
          ['cpuStatus', 'ramStatus', 'gpuStatus', 'netStatus'].forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.textContent = 'Reconnecting…';
          });
          setTimeout(connectWs, 2000);
        };

        ws.onmessage = (event) => {
          const payload = JSON.parse(event.data);
          const label = new Date(payload.timestamp).toLocaleTimeString();
          const cpu = Number(payload.cpuLoad.toFixed(1));
          const ram = Number(payload.memory.usedPercent.toFixed(1));
          const gpu = payload.gpu && payload.gpu.length && payload.gpu[0].utilization != null ? payload.gpu[0].utilization : 0;
          const netDown = payload.network.rxSec / 1024;
          const netUp = payload.network.txSec / 1024;
          pushPoint(label, cpu, gpu, ram, netDown, netUp);

          if (payload.cpuTemp != null) {
            document.getElementById('cpuTempValue').textContent = `${payload.cpuTemp.toFixed(0)}°C`;
          }
          if (payload.gpu && payload.gpu.length && payload.gpu[0].temperature != null) {
            document.getElementById('gpuTempValue').textContent = `${payload.gpu[0].temperature.toFixed(0)}°C`;
          }
          document.getElementById('netSpeedValue').textContent = `${netDown.toFixed(1)} KB/s ↓  •  ${netUp.toFixed(1)} KB/s ↑`;
        };
      }

      async function sendPowerCommand(endpoint) {
        const statusEl = document.getElementById('statusText');
        try {
          const res = await fetch(endpoint, { method: 'POST' });
          const body = await res.json();
          if (!res.ok) throw new Error(body.error || 'failed');
          statusEl.textContent = body.status || 'Command sent.';
        } catch (err) {
          statusEl.textContent = 'Power command failed: ' + err.message;
        }
      }

      document.getElementById('shutdownBtn').addEventListener('click', () => sendPowerCommand('/api/power/shutdown'));
      document.getElementById('rebootBtn').addEventListener('click', () => sendPowerCommand('/api/power/reboot'));

      initCharts();
      fetchInfo();
      connectWs();

      function resizeCanvas(canvas) {
        if (!canvas) return;
        const ratio = window.devicePixelRatio || 1;
        canvas.width = canvas.clientWidth * ratio;
        canvas.height = (window.innerWidth < 720 ? 220 : 260) * ratio;
      }

      function drawAll() {
        drawSingle('cpu', [ { key: 'cpu', color: '#5af8ff', label: 'CPU %' } ], 100);
        drawSingle('ram', [ { key: 'ram', color: '#6bf7c4', label: 'RAM %' } ], 100);
        drawSingle('gpu', [ { key: 'gpu', color: '#9a5cff', label: 'GPU %' } ], 100);
        drawSingle('net', [
          { key: 'netDown', color: '#5af8ff', label: 'Down KB/s' },
          { key: 'netUp', color: '#f7d66b', label: 'Up KB/s' },
        ]);
      }

      function drawSingle(key, datasets, maxYDefault = null) {
        const chart = state.charts[key];
        if (!chart) return;
        const ctx = chart.ctx;
        const { width, height } = chart.canvas;
        ctx.clearRect(0, 0, width, height);
        const ratio = window.devicePixelRatio || 1;
        const padding = 40 * ratio;
        const innerW = width - padding * 2;
        const innerH = height - padding * 2;

        const len = state.labels.length;
        const start = Math.max(0, len - state.windowSize);
        const labels = state.labels.slice(start, len);

        chart.points = [];
        datasets.forEach((ds) => {
          const values = state.series[ds.key].slice(start, len);
          const maxY = maxYDefault || Math.max(50, Math.max(...values, 1));

          ctx.strokeStyle = 'rgba(255,255,255,0.05)';
          ctx.lineWidth = 1;
          for (let i = 0; i <= 4; i++) {
            const y = padding + (innerH / 4) * i;
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();
          }

          if (!values.length) return;
          ctx.strokeStyle = ds.color;
          ctx.lineWidth = 2 * ratio;
          ctx.beginPath();
          values.forEach((val, idx) => {
            const x = padding + (idx / Math.max(values.length - 1, 1)) * innerW;
            const y = padding + innerH - (Math.min(val, maxY) / maxY) * innerH;
            if (idx === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
            chart.points.push({ x, y, label: labels[idx], value: val, key: ds.label, color: ds.color });
          });
          ctx.stroke();
        });

        const windowLabel = document.getElementById(`${key}WindowLabel`);
        if (windowLabel) windowLabel.textContent = `${state.windowSize}s window`;
      }

      function handleHover(chartKey, evt) {
        const chart = state.charts[chartKey];
        if (!chart || !chart.points.length) return;
        const rect = chart.canvas.getBoundingClientRect();
        const ratio = window.devicePixelRatio || 1;
        const x = (evt.clientX - rect.left) * ratio;
        const y = (evt.clientY - rect.top) * ratio;

        let nearest = null;
        chart.points.forEach((p) => {
          const dist = Math.hypot(p.x - x, p.y - y);
          if (!nearest || dist < nearest.dist) nearest = { ...p, dist };
        });

        if (nearest && nearest.dist < 30 * ratio) {
          showTooltip(nearest, rect);
        } else {
          showTooltip(null);
        }
      }

      function showTooltip(point, rect) {
        let tip = document.getElementById('chartTooltip');
        if (!tip) {
          tip = document.createElement('div');
          tip.id = 'chartTooltip';
          document.body.appendChild(tip);
        }
        if (!point) {
          tip.style.display = 'none';
          return;
        }
        tip.style.display = 'block';
        tip.style.background = 'rgba(15,16,26,0.9)';
        tip.style.border = `1px solid ${point.color}`;
        tip.style.borderRadius = '8px';
        tip.style.padding = '8px 10px';
        tip.style.color = '#e8f1ff';
        tip.style.font = '12px "JetBrains Mono", monospace';
        tip.style.boxShadow = '0 10px 30px rgba(0,0,0,0.4)';
        tip.innerHTML = `
          <div style="color:${point.color}; text-transform: uppercase; letter-spacing: 0.5px;">${point.key}</div>
          <div>${point.label}</div>
          <div>${point.value.toFixed ? point.value.toFixed(1) : point.value} ${point.key.includes('KB') ? 'KB/s' : '%'}</div>
        `;
        tip.style.position = 'fixed';
        tip.style.left = `${rect.left + point.x / (window.devicePixelRatio || 1) + 12}px`;
        tip.style.top = `${rect.top + point.y / (window.devicePixelRatio || 1) - 10}px`;
      }
    </script>
  </body>
</html>
